name: 🚀 Deploy Laravel App on Push

on:
  push:
    branches:
      - master  # Trigger on push to master

jobs:
  deploy:
    name: 🎉 Deploy Laravel App
    if: contains(github.event.head_commit.message, '[deploy]')
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout code
    - name: 🚚 Get latest code
      uses: actions/checkout@v3

    # Step 2: Install PHP and dependencies
    - name: 🛠️ Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2' # Adjust PHP version if needed
        tools: composer
        coverage: none

    - name: 📦 Install Laravel dependencies
      run: composer install --no-dev --optimize-autoloader

    # Step 3: Sync files to FTP using appleboy/ftp-action
    - name: 📂 Sync files to FTP
      uses: appleboy/ftp-action@v1.0.0
      with:
        host: ftp.kingland.ph
        username: ${{ secrets.FTPUSERNAME }}
        password: ${{ secrets.FTPPASSWORD }}
        port: 21  # Adjust if needed (usually 21 for FTP)
        source: "public/"  # The directory you want to upload (public directory)
        target: "/public_html"  # The target directory on the FTP server
        keepalive: 600  # Keep connection alive for 10 minutes
        timeout: 1200  # Timeout after 20 minutes if no activity
        exclude: |
          .env
          .git*
          node_modules/
          vendor/
          storage/
          tests/
          *.lock

    # Step 4: Fix permissions (optional)
    - name: 🔧 Fix permissions (Optional)
      run: |
        chmod -R 755 public_html/
        chmod -R 777 public_html/storage/
