name: 🚀 Deploy Laravel App on Push

on:
  push:
    branches:
      - master  # Trigger on push to master

jobs:
  deploy:
    name: 🎉 Deploy Laravel App
    if: contains(github.event.head_commit.message, '[deploy]')  # Only trigger when commit message contains '[deploy]'
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout code
    - name: 🚚 Get latest code
      uses: actions/checkout@v3

    # Step 2: Set up PHP environment and install dependencies
    - name: 🛠️ Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'  # Adjust PHP version if needed
        tools: composer
        coverage: none

    - name: 📦 Install Laravel dependencies
      run: composer install --no-dev --optimize-autoloader

    # Step 3: Install lftp
    - name: 🔧 Install lftp
      run: sudo apt-get install lftp -y

    # Step 4: Sync files to FTP server using Penguibird's FTP-Deploy-Action
    - name: 📂 Sync files to FTP
      uses: Penguibird/FTP-Deploy-Action@4.2.0
      with:
        server: ftp.kingland.ph  # Replace with your actual FTP server
        username: ${{ secrets.FTPUSERNAME }}  # Use the GitHub secret for username
        password: ${{ secrets.FTPPASSWORD }}  # Use the GitHub secret for password
        server-dir: /public_html/  # Directory where files need to be uploaded
        local-dir: ./public/  # Local directory to sync (from your GitHub workspace)
        exclude: |
          .env
          .git*
          node_modules/
          vendor/
          storage/
          tests/
          *.lock

    # Step 5: Fix file permissions via SSH (Optional) RECOMMIT
    - name: 🔧 Fix file permissions (Optional)
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.FTPUSERNAME }}@ftp.kingland.ph "chmod -R 755 public_html && chmod -R 777 public_html/storage/"
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}  # Use the SSH private key for authentication
