name: ğŸš€ Deploy Laravel App on Push

on:
  push:
    branches:
      - main  # Trigger on pushes to the 'main' branch

jobs:
  deploy:
    name: ğŸ‰ Deploy Laravel App
    if: contains(github.event.head_commit.message, '[deploy]')
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout code
    - name: ğŸšš Get latest code
      uses: actions/checkout@v3

    # Step 2: Install PHP and dependencies
    - name: ğŸ› ï¸ Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1' # Adjust the PHP version to match your Laravel appa
        tools: composer
        coverage: none

    - name: ğŸ“¦ Install Laravel dependencies
      run: composer install --no-dev --optimize-autoloader

    # Step 3: Build front-end assets (if applicable)
    - name: âš¡ Build assets
      run: |
        npm ci
        npm run prod

    # Step 4: Sync files to FTP
    # Sync files to FTP without building
    - name: ğŸ“‚ Sync files to FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: 184.168.113.220
        username: ${{ secrets.FTPUSERNAME }}
        password: ${{ secrets.FTPPASSWORD }}
        protocol: ftps
        server-dir: public_html/
        local-dir: public/ # Upload your prebuilt files
        exclude: |
          .env
          .git*
          node_modules/
          vendor/
          storage/
          tests/
          *.lock


    # Step 5: Fix permissions (optional)
    - name: ğŸ”§ Fix permissions (Optional)
      run: |
        chmod -R 755 public_html/
        chmod -R 777 public_html/storage/
