name: 🚀 Deploy Laravel App on Push

on:
  push:
    branches:
      - master  # Trigger on push to master

jobs:
  deploy:
    name: 🎉 Deploy Laravel App
    if: contains(github.event.head_commit.message, '[deploy]')
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout code
    - name: 🚚 Get latest code
      uses: actions/checkout@v3

    # Step 2: Install PHP and dependencies
    - name: 🛠️ Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2' # Adjust PHP version if needed
        tools: composer
        coverage: none

    - name: 📦 Install Laravel dependencies
      run: composer install --no-dev --optimize-autoloader

    # Step 3: Install lftp
    - name: 🔧 Install lftp
      run: sudo apt-get install lftp

    # Step 4: Sync files to FTP using lftp / re-add secret
    - name: 📂 Sync files to FTP
      run: |
        lftp -u ${{ secrets.FTPUSERNAME }},${{ secrets.FTPPASSWORD }} -e "
        set net:timeout 60;  # Increase timeout for connection
        set ftp:passive-mode on;  # Enable passive mode
        mirror -R ./public /public_html --exclude .env --exclude .git* --exclude node_modules/ --exclude vendor/ --exclude storage/ --exclude tests/;
        bye
        " ftp://ftp.kingland.ph

    # Step 5: Fix permissions (optional)
    - name: 🔧 Fix permissions (Optional)
      run: |
        ssh ${{ secrets.FTPUSERNAME }}@ftp.kingland.ph "chmod -R 755 public_html && chmod -R 777 public_html/storage/"
